<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alke Wallet - Historial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark py-3 sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-white" href="menu.html">← Menú Principal</a>
        </div>
    </nav>
    
    <!-- HEADER -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-11">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h2 class="fw-bold fs-1 text-primary mb-1">Historial Completo</h2>
                        <p class="text-muted mb-0 fs-6">Todas tus transacciones recientes</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success fs-5 px-4 py-2 shadow-sm" id="saldoHistorial">$10,000</span>
                    </div>
                </div>
                
                <!-- FILTROSS -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <select class="form-select" id="filtroTipo">
                                    <option value="todos">Todos</option>
                                    <option value="ingreso">Ingresos</option>
                                    <option value="egreso">Egresos</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="filtroFecha" onchange="aplicarFiltros()">
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary" onclick="limpiarFiltros()">
                                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- TABLA DINÁMICA -->
                <div class="card shadow-xl overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle" id="tablaMovimientos">
                            <thead>
                                <tr>
                                    <th scope="col" class="position-sticky bg-white" style="z-index: 10;">Fecha</th>
                                    <th scope="col" class="position-sticky bg-white" style="z-index: 10;">Descripción</th>
                                    <th scope="col" class="position-sticky bg-white" style="z-index: 10;">Tipo</th>
                                    <th scope="col" class="position-sticky bg-white" style="z-index: 10;">Monto</th>
                                    <th scope="col" class="position-sticky bg-white" style="z-index: 10;">Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyMovimientos">
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer text-muted text-center py-3">
                        <small id="totalMovimientos">0 movimientos registrados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <script>

    /* SISTEMA HISTORIAL PERSISTENTE*/

    let historial = JSON.parse(localStorage.getItem('historialMovimientos')) || [];
    let saldo = parseFloat(localStorage.getItem('saldo')) || 10000;
    
    /* CARGA Y MUESTRA HISTORIAL */
    function cargarHistorial() {
        const tbody = document.getElementById('tbodyMovimientos');
        const saldoActual = document.getElementById('saldoHistorial');

        
        // ACTUALIZA SALDO 
        saldoActual.textContent = `$${saldo.toLocaleString()}`;
        saldoActual.parentElement.parentElement.parentElement.parentElement.parentElement.href = 'menu.html';
        
        tbody.innerHTML = '';
        
        if (historial.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        <i class="bi bi-receipt fs-1 d-block mb-3 opacity-50"></i>
                        <h5>No hay movimientos aún</h5>
                        <p class="mb-0">Realiza depósitos o transferencias para ver historial</p>
                    </td>
                </tr>
            `;
            document.getElementById('totalMovimientos').textContent = '0 movimientos registrados';
            return;
        }
        
        /* ORDENA POR FECHA DESC (RECIENTE PRIMERO) */
        historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        historial.forEach((movimiento, index) => {
            const fila = document.createElement('tr');
            const claseTipo = movimiento.tipo === 'ingreso' ? 'ingreso' : 'egreso';
            const icono = movimiento.tipo === 'ingreso' ? 'arrow-up-circle' : 'arrow-down-circle';
            
            fila.innerHTML = `
                <td class="fw-semibold">
                    <div>${new Date(movimiento.fecha).toLocaleDateString('es-CL')}</div>
                    <small class="text-muted">${new Date(movimiento.fecha).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
                </td>
                <td>
                    <strong>${movimiento.descripcion}</strong>
                    ${movimiento.contacto ? `<br><small class="text-muted">→ ${movimiento.contacto}</small>` : ''}
                </td>
                <td>
                    <span class="badge bg-${claseTipo === 'ingreso' ? 'success' : 'danger'} px-3 py-2 fs-6">
                        <i class="bi bi-${icono} me-1"></i>
                        ${movimiento.tipo === 'ingreso' ? '+' : '-'}${movimiento.operacion}
                    </span>
                </td>
                <td class="${claseTipo} fs-4 fw-bold">
                    ${movimiento.tipo === 'ingreso' ? '+' : '-'}$${Math.abs(movimiento.monto).toLocaleString()}
                </td>
                <td class="fw-bold fs-5 text-primary">
                    $${movimiento.saldoPosterior.toLocaleString()}
                </td>
            `;
            tbody.appendChild(fila);
        });
        
        document.getElementById('totalMovimientos').textContent = 
            `${historial.length} movimiento${historial.length !== 1 ? 's' : ''} registrado${historial.length !== 1 ? 's' : ''}`;
    }
    
    /* FILTROS DINÁMICOS*/
    function aplicarFiltros() {
        const tipo = document.getElementById('filtroTipo').value;
        const fecha = document.getElementById('filtroFecha').value;
        
        let movimientosFiltrados = [...historial];
        
        if (tipo !== 'todos') {
            movimientosFiltrados = movimientosFiltrados.filter(m => m.tipo === tipo);
        }
        
        if (fecha) {
            movimientosFiltrados = movimientosFiltrados.filter(m => 
                new Date(m.fecha).toISOString().split('T')[0] === fecha
            );
        }
        
        // SIMULA filtro temporalmente (SE PUEDE expandir)
        const tbody = document.getElementById('tbodyMovimientos');
        tbody.innerHTML = '';
        
        if (movimientosFiltrados.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5 text-muted">
                        <i class="bi bi-funnel fs-1 d-block mb-3 opacity-50"></i>
                        No hay resultados para estos filtros
                    </td>
                </tr>
            `;
        } else {
            movimientosFiltrados.forEach(movimiento => {
                // Render similar a cargarHistorial()
                const fila = document.createElement('tr');
                tbody.appendChild(fila);
            });
        }
    }
    
    function limpiarFiltros() {
        document.getElementById('filtroTipo').value = 'todos';
        document.getElementById('filtroFecha').value = '';
        cargarHistorial();
    }
    
    /* INICIALIZACIÓN */
    document.addEventListener('DOMContentLoaded', function() {
        cargarHistorial();

        
        // ESCUCHA CAMBIOS EN OTRAS PÁGINAS
        if ('BroadcastChannel' in window) {
            const canal = new BroadcastChannel('alke-wallet');
            canal.onmessage = function(event) {
                if (event.data === 'historial-updated') {
                    historial = JSON.parse(localStorage.getItem('historialMovimientos')) || [];
                    cargarHistorial();
                }
            };
        }
    });
    </script>
</body>
</html>
